<div class="admin-dashboard">
  <header class="dashboard-header">
    <div>
      <h1>Dashboard Admin</h1>
      <p class="subtitle">Magasin & Stock en temps r√©el</p>
    </div>
    <button class="alerts-header-btn" [class.has-alerts]="openAlertsCount() > 0" (click)="selectView('alerts')" [attr.aria-label]="'Afficher les ' + openAlertsCount() + ' alerte(s)'">
      <span class="alert-icon-header">
        @if (openAlertsCount() > 0) {
          üîî
        } @else {
          üîî
        }
      </span>
      <span class="alert-badge">{{ openAlertsCount() }}</span>
    </button>
  </header>

  @if (alertToast()) {
    <div class="alert-toast" role="status" (click)="goToAlertsFromToast()">
      <div class="toast-icon">‚ö†Ô∏è</div>
      <div class="toast-content">
        <p class="toast-title">Poids insuffisant</p>
        <p class="toast-message">{{ alertToast()!.message }}</p>
      </div>
      <button class="toast-action" type="button">Voir alertes</button>
      <button class="toast-close" type="button" (click)="$event.stopPropagation(); dismissAlertToast()" aria-label="Fermer">
        ‚úï
      </button>
    </div>
  }

  <!-- VUE ACCUEIL : Grandes cartes cliquables -->
  @if (selectedView() === 'home') {
    @if (isLoadingStats()) {
      <div class="loading-skeleton">
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
        <div class="skeleton-card"></div>
      </div>
    } @else if (stats()) {
      <section class="dashboard-cards">
        <div class="dashboard-card" (click)="selectView('stock')">
          <div class="card-icon">üè¢</div>
          <h2>Stock Principal</h2>
          <p class="card-value">{{ stats()!.totalStock }}</p>
          <p class="card-unit">unit√©s</p>
          <p class="card-action">Voir les d√©tails ‚Üí</p>
        </div>
        <div class="dashboard-card" (click)="selectView('store')">
          <div class="card-icon">üè™</div>
          <h2>Stock Magasin</h2>
          <p class="card-value">{{ stats()!.totalStoreStock }}</p>
          <p class="card-unit">produits</p>
          <p class="card-action">Voir les d√©tails ‚Üí</p>
        </div>
        <div class="dashboard-card" (click)="selectView('products')">
          <div class="card-icon">üì¶</div>
          <h2>Produits Total</h2>
          <p class="card-value">{{ stats()!.totalProducts }}</p>
          <p class="card-unit">produits</p>
          <p class="card-action">Voir les d√©tails ‚Üí</p>
        </div>
        <div class="dashboard-card" (click)="selectView('shelves')">
          <div class="card-icon">üóÑÔ∏è</div>
          <h2>√âtag√®res Magasin</h2>
          <p class="card-value">{{ stats()!.totalShelves }}</p>
          <p class="card-unit">√©tag√®res</p>
          <p class="card-action">G√©rer les √©tag√®res ‚Üí</p>
        </div>
        <div class="dashboard-card" (click)="selectView('sales')">
          <div class="card-icon">üí∞</div>
          <h2>Point de Vente</h2>
          <p class="card-value">‚Äî</p>
          <p class="card-unit">ventes</p>
          <p class="card-action">Enregistrer une vente ‚Üí</p>
        </div>
      </section>
    }
  }

  <!-- VUE D√âTAILS : Stock -->
  @if (selectedView() === 'stock') {
    <div class="details-view">
      <header class="details-header">
        <button class="back-btn" (click)="goBack()">‚Üê Retour</button>
        <h2>D√©tails Stock Principal</h2>
      </header>

      <section class="recent-movements">
        <header class="section-header">
          <h3>Mouvements Stock Principal</h3>
          <button class="refresh-btn" (click)="refreshCurrentLocationEvents()" [disabled]="isLoadingEvents()">
            üîÑ
          </button>
        </header>

        @if (isLoadingEvents()) {
          <div class="loading-table">
            <div class="skeleton-row"></div>
            <div class="skeleton-row"></div>
            <div class="skeleton-row"></div>
          </div>
        } @else if (recentEvents() && recentEvents().length > 0) {
          <div class="table-responsive">
            <table class="events-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Produit</th>
                  <th>Produit ID</th>
                  <th>Localisation</th>
                  <th>Appareil</th>
                  <th>Date/Heure</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (event of recentEvents(); track event.id) {
                  <tr class="event-row" [class.entry]="event.eventType === 'ENTRY'" [class.exit]="event.eventType === 'EXIT'">
                    <td class="event-badge">
                      <span class="badge-icon">{{ getEventIcon(event.eventType, event.location) }}</span>
                      {{ getEventLabel(event.eventType, event.location) }}
                    </td>
                    <td class="product-name"><strong>{{ event.productName }}</strong></td>
                    <td><code>{{ event.productId }}</code></td>
                    <td>
                      <span class="location-badge" [class.stock]="event.location === 'STOCK'" [class.store]="event.location === 'STORE'">
                        {{ event.location }}
                      </span>
                    </td>
                    <td><small>{{ event.esp32Id }}</small></td>
                    <td class="time">{{ event.createdAt | date: 'dd/MM HH:mm:ss' }}</td>
                    <td class="actions">
                      <button class="btn-delete" (click)="deleteEvent(event)" [disabled]="isLoadingDeleteEvent() === event.id" title="Supprimer">
                        @if (isLoadingDeleteEvent() === event.id) {
                          <span class="spinner-small"></span>
                        } @else {
                          üóëÔ∏è
                        }
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="empty-state">
            <p>üì≠ Aucun mouvement enregistr√©</p>
          </div>
        }
      </section>
    </div>
  }

  <!-- VUE D√âTAILS : Stock Magasin -->
  @if (selectedView() === 'store') {
    <div class="details-view">
      <header class="details-header">
        <button class="back-btn" (click)="goBack()">‚Üê Retour</button>
        <h2>Contenu Stock Magasin</h2>
      </header>

      <section class="store-stock-section">
        <header class="section-header">
          <h3>üì¶ Inventaire Magasin</h3>
          <button class="refresh-btn" (click)="loadStoreStock()" [disabled]="isLoadingStoreStock()">
            üîÑ Actualiser
          </button>
        </header>

        @if (isLoadingStoreStock()) {
          <div class="store-stock-grid">
            <div class="stock-card skeleton-card"></div>
            <div class="stock-card skeleton-card"></div>
            <div class="stock-card skeleton-card"></div>
          </div>
        } @else if (storeStock() && storeStock().length > 0) {
          <div class="store-stock-grid">
            @for (item of storeStock(); track item.id) {
              <div class="stock-card">
                <div class="stock-card-header">
                  <div class="product-info">
                    <h4 class="product-title">{{ item.productName }}</h4>
                    <span class="product-barcode">üìä {{ item.productBarcode }}</span>
                  </div>
                  <div class="shelf-badge">
                    <span class="shelf-icon">üóÑÔ∏è</span>
                    <span class="shelf-name">{{ item.shelfName }}</span>
                  </div>
                </div>
                
                <div class="stock-card-body">
                  <div class="stock-metric">
                    <span class="metric-label">Quantit√©</span>
                    <span class="metric-value quantity-badge">{{ item.quantity }} unit√©s</span>
                  </div>
                  
                  <div class="stock-metrics-row">
                    <div class="stock-metric-small">
                      <span class="metric-label-small">Poids unitaire</span>
                      <span class="metric-value-small">{{ item.unitWeight }} kg</span>
                    </div>
                    <div class="stock-metric-small">
                      <span class="metric-label-small">Poids total</span>
                      <span class="metric-value-small weight-total">{{ (item.quantity * item.unitWeight).toFixed(3) }} kg</span>
                    </div>
                  </div>
                </div>
                
                <div class="stock-card-footer">
                  <span class="update-time">üïí {{ item.lastUpdated | date: 'dd/MM/yyyy √† HH:mm' }}</span>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <p>Aucun article en magasin</p>
            <p class="empty-subtitle">Les produits appara√Ætront ici une fois ajout√©s</p>
          </div>
        }
      </section>
    </div>
  }

  <!-- VUE D√âTAILS : Produits -->
  @if (selectedView() === 'products') {
    <div class="details-view">
      <header class="details-header">
        <button class="back-btn" (click)="goBack()">‚Üê Retour</button>
        <div class="header-title-section">
          <h2>Gestion des Produits</h2>
          <button class="refresh-btn" (click)="loadProducts()" [disabled]="isLoadingProducts()">
            üîÑ
          </button>
        </div>
        <button class="add-product-btn" (click)="openAddProductForm()">+ Ajouter un produit</button>
      </header>

      @if (isLoadingProducts()) {
        <div class="loading-table">
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
        </div>
      } @else if (products() && products().length > 0) {
        <div class="table-responsive">
          <table class="products-table">
            <thead>
              <tr>
                <th>Nom</th>
                <th>Code-barres</th>
                <th>Tag RFID</th>
                <th>Poids (kg)</th>
                <th>Stock</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (product of products(); track product.id) {
                <tr class="product-row">
                  <td class="product-name"><strong>{{ product.name }}</strong></td>
                  <td><code>{{ product.barcode }}</code></td>
                  <td><code class="rfid-code">{{ product.rfidTag }}</code></td>
                  <td class="text-center">{{ product.unitWeight }}</td>
                  <td class="text-center stock-quantity">
                    <span class="stock-badge">{{ product.stockQuantity }}</span>
                  </td>
                  <td class="product-desc">{{ product.description || '‚Äî' }}</td>
                  <td class="actions">
                    <button class="btn-edit" (click)="openEditProductForm(product)" title="Modifier">‚úé √âditer</button>
                    <button class="btn-delete" (click)="deleteProduct(product)" [disabled]="isLoadingDelete() === product.id" title="Supprimer">
                      @if (isLoadingDelete() === product.id) {
                        <span class="spinner-small"></span>
                      } @else {
                        üóëÔ∏è Supprimer
                      }
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      } @else {
        <div class="empty-state">
          <p>üì≠ Aucun produit enregistr√©</p>
          <button class="btn-primary" (click)="openAddProductForm()">Ajouter le premier produit</button>
        </div>
      }
    </div>
  }

  <!-- VUE D√âTAILS : √âtag√®res -->
  @if (selectedView() === 'shelves') {
    <div class="details-view">
      <header class="details-header">
        <button class="back-btn" (click)="goBack()">‚Üê Retour</button>
        <div class="header-title-section">
          <h2>Gestion des √âtag√®res</h2>
          <button class="refresh-btn" (click)="loadShelves()" [disabled]="isLoadingShelves()">
            üîÑ
          </button>
        </div>
        <button class="add-product-btn" (click)="openAddShelfForm()">+ Ajouter une √©tag√®re</button>
      </header>

      @if (isLoadingShelves()) {
        <div class="shelves-grid">
          <div class="shelf-card skeleton-card"></div>
          <div class="shelf-card skeleton-card"></div>
          <div class="shelf-card skeleton-card"></div>
        </div>
      } @else if (shelves() && shelves().length > 0) {
        <div class="shelves-grid">
          @for (shelf of shelves(); track shelf.id) {
            <div class="shelf-card">
              <div class="shelf-card-header" 
                   [class.status-low]="shelf.currentWeight < shelf.minThreshold"
                   [class.status-overload]="shelf.currentWeight > shelf.maxWeight"
                   [class.status-ok]="shelf.currentWeight >= shelf.minThreshold && shelf.currentWeight <= shelf.maxWeight">
                <div class="shelf-info">
                  <span class="shelf-icon">üì¶</span>
                  <h3 class="shelf-title">{{ shelf.name }}</h3>
                </div>
                <div class="shelf-status-badge">
                  @if (shelf.currentWeight < shelf.minThreshold) {
                    <span class="status-indicator low">‚ö†Ô∏è Faible</span>
                  } @else if (shelf.currentWeight > shelf.maxWeight) {
                    <span class="status-indicator overload">‚ö†Ô∏è Surcharge</span>
                  } @else {
                    <span class="status-indicator ok">‚úì OK</span>
                  }
                </div>
              </div>

              <div class="shelf-card-body">
                <div class="weight-display">
                  <div class="current-weight">
                    <span class="weight-label">Poids Actuel</span>
                    <span class="weight-value">{{ shelf.currentWeight }} kg</span>
                  </div>
                  <div class="weight-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" 
                           [style.width.%]="(shelf.currentWeight / shelf.maxWeight) * 100"
                           [class.fill-low]="shelf.currentWeight < shelf.minThreshold"
                           [class.fill-overload]="shelf.currentWeight > shelf.maxWeight"
                           [class.fill-ok]="shelf.currentWeight >= shelf.minThreshold && shelf.currentWeight <= shelf.maxWeight">
                      </div>
                      <div class="threshold-marker" [style.left.%]="(shelf.minThreshold / shelf.maxWeight) * 100"></div>
                    </div>
                  </div>
                </div>

                <div class="weight-metrics">
                  <div class="metric-item">
                    <span class="metric-icon">üìè</span>
                    <div class="metric-content">
                      <span class="metric-label">Seuil Min</span>
                      <span class="metric-value">{{ shelf.minThreshold }} kg</span>
                    </div>
                  </div>
                  <div class="metric-item">
                    <span class="metric-icon">‚öñÔ∏è</span>
                    <div class="metric-content">
                      <span class="metric-label">Poids Max</span>
                      <span class="metric-value">{{ shelf.maxWeight }} kg</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="shelf-card-footer">
                <button class="btn-edit-shelf" (click)="openEditShelfForm(shelf)" title="Modifier">
                  ‚úé Modifier
                </button>
                <button class="btn-delete-shelf" 
                        (click)="deleteShelf(shelf)" 
                        [disabled]="isLoadingDeleteShelf() === shelf.id" 
                        title="Supprimer">
                  @if (isLoadingDeleteShelf() === shelf.id) {
                    <span class="spinner-small"></span>
                  } @else {
                    üóëÔ∏è Supprimer
                  }
                </button>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <div class="empty-icon">üì¶</div>
          <p class="empty-title">Aucune √©tag√®re enregistr√©e</p>
          <p class="empty-subtitle">Commencez par ajouter votre premi√®re √©tag√®re</p>
          <button class="btn-primary" (click)="openAddShelfForm()">+ Ajouter une √©tag√®re</button>
        </div>
      }
    </div>
  }
</div>

<!-- Formulaire Modal -->
@if (isFormOpen()) {
  <div class="modal-backdrop" role="presentation" (click)="closeProductForm()"></div>
  <div class="modal" role="dialog" aria-modal="true" [attr.aria-labelledby]="formMode() === 'new_rfid' ? 'new-product-title' : 'edit-product-title'">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <div>
          @if (formMode() === 'new_rfid') {
            <div class="form-header-icon">üÜï</div>
            <h2 id="new-product-title">Nouveau produit d√©tect√©</h2>
            @if (currentLocation()) {
              <p class="muted">Localisation: <strong>{{ currentLocation() }}</strong></p>
            }
          } @else if (formMode() === 'edit_product') {
            <div class="form-header-icon">‚úé</div>
            <h2 id="edit-product-title">Modifier le produit</h2>
          } @else {
            <div class="form-header-icon">‚ûï</div>
            <h2 id="edit-product-title">Ajouter un nouveau produit</h2>
          }
        </div>
        <button class="icon-button" type="button" (click)="closeProductForm()" aria-label="Fermer">
          ‚úï
        </button>
      </header>

      <form class="product-form" [formGroup]="productForm" (ngSubmit)="submitProduct()">
        <div class="form-grid">
          <label class="form-field">
            <span>Nom du produit *</span>
            <input type="text" formControlName="name" placeholder="Ex: Coca-Cola 1.5L" />
            @if (productForm.controls.name.touched && productForm.controls.name.invalid) {
              <span class="error">Le nom est obligatoire.</span>
            }
          </label>

          <label class="form-field">
            <span>Code-barres *</span>
            <input type="text" formControlName="barcode" placeholder="Ex: 5449000000996" />
            @if (productForm.controls.barcode.touched && productForm.controls.barcode.invalid) {
              <span class="error">Le code-barres est obligatoire.</span>
            }
          </label>

          <label class="form-field">
            <span>RFID tag
              @if (formMode() !== 'new_rfid') {
                <span class="required">*</span>
              }
            </span>
            <input 
              type="text" 
              formControlName="rfidTag" 
              [readonly]="formMode() === 'new_rfid'"
              [class.readonly-input]="formMode() === 'new_rfid'"
              placeholder="Ex: RFID-001234567890" />
            @if (formMode() !== 'new_rfid' && productForm.controls.rfidTag.touched && productForm.controls.rfidTag.invalid) {
              <span class="error">Le tag RFID est obligatoire.</span>
            }
          </label>

          <label class="form-field">
            <span>Poids unitaire (kg) *</span>
            <input type="number" formControlName="unitWeight" min="0.001" step="0.001" placeholder="0.5" />
            @if (productForm.controls.unitWeight.touched && productForm.controls.unitWeight.invalid) {
              <span class="error">Le poids doit √™tre sup√©rieur √† 0.</span>
            }
          </label>
        </div>

        <label class="form-field full-width">
          <span>Description</span>
          <textarea rows="4" formControlName="description" placeholder="Description du produit..."></textarea>
        </label>

        @if (errorMessage()) {
          <div class="alert error" role="alert">
            <span class="alert-icon">‚ö†Ô∏è</span>
            {{ errorMessage() }}
          </div>
        }
        @if (successMessage()) {
          <div class="alert success" role="status">
            <span class="alert-icon">‚úì</span>
            {{ successMessage() }}
          </div>
        }

        <div class="modal-actions">
          <button class="secondary" type="button" (click)="closeProductForm()">Annuler</button>
          <button class="primary" type="submit" [disabled]="isSaving()">
            @if (isSaving()) {
              <span class="spinner"></span>
              Enregistrement...
            } @else {
              üíæ Enregistrer
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}

<!-- VUE ALERTES -->
@if (selectedView() === 'alerts') {
  <div class="details-view">
    <header class="details-header">
      <button class="back-btn" (click)="goBack()">‚Üê Retour</button>
      <h2>Alertes Syst√®me</h2>
    </header>

    <section class="alerts-section">
      <header class="section-header">
        <h3>Alertes Actives</h3>
        <button class="refresh-btn" (click)="loadAlerts()" [disabled]="isLoadingAlerts()">
          üîÑ
        </button>
      </header>

      @if (isLoadingAlerts()) {
        <div class="loading-table">
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
          <div class="skeleton-row"></div>
        </div>
      } @else if (alerts() && alerts().length > 0) {
        <div class="alerts-list">
          @for (alert of alerts(); track alert.id) {
            <div class="alert-item" [class.low-weight]="alert.alertType === 'LOW_WEIGHT'">
              <div class="alert-icon">
                @if (alert.alertType === 'LOW_WEIGHT') {
                  ‚ö†Ô∏è
                } @else {
                  üîî
                }
              </div>
              <div class="alert-info">
                <h4>{{ alert.shelfName }}</h4>
                <p class="alert-type">
                  @if (alert.alertType === 'LOW_WEIGHT') {
                    Poids faible - Besoin de remplissage
                  } @else {
                    {{ alert.alertType }}
                  }
                </p>
                <p class="alert-date">
                  <span class="date-icon">üìÖ</span>
                  {{ alert.createdAt }}
                </p>
              </div>
              <div class="alert-actions">
                <button 
                  class="resolve-btn" 
                  (click)="resolveAlert(alert)"
                  [disabled]="isResolvingAlert() === alert.id"
                >
                  @if (isResolvingAlert() === alert.id) {
                    <span class="spinner"></span>
                    Traitement...
                  } @else {
                    ‚úì R√©soudre
                  }
                </button>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty-state">
          <div class="empty-icon">‚úÖ</div>
          <p>Aucune alerte active</p>
          <p class="empty-subtitle">Toutes les √©tag√®res sont remplies correctement</p>
        </div>
      }
    </section>
  </div>
}

<!-- VUE VENTES -->
@if (selectedView() === 'sales') {
  <div class="details-view">
    <header class="details-header">
      <button class="back-btn" (click)="goBack()">‚Üê Retour</button>
      <h2>Point de Vente</h2>
    </header>

    <section class="sales-section">
      <div class="sales-form-container">
        <div class="sales-form-header">
          <h3>üí∞ Enregistrer une vente</h3>
          <p class="subtitle">Scannez ou entrez le code-barres du produit</p>
        </div>

        <form [formGroup]="saleForm" class="sale-form">
          <!-- Recherche par code-barres -->
          <div class="barcode-search-section">
            <label class="form-field">
              <span>Code-barres du produit</span>
              <div class="input-with-button">
                <input 
                  type="text" 
                  formControlName="barcode" 
                  placeholder="Scannez ou tapez le code-barres"
                  (keyup.enter)="searchProductByBarcode()"
                  autofocus
                />
                <button 
                  type="button" 
                  class="btn-search" 
                  (click)="searchProductByBarcode()"
                  [disabled]="isSearchingProduct() || !saleForm.controls.barcode.value.trim()"
                >
                  @if (isSearchingProduct()) {
                    <span class="spinner-small"></span>
                  } @else {
                    üîç Rechercher
                  }
                </button>
              </div>
            </label>
          </div>

          @if (saleErrorMessage()) {
            <div class="alert error" role="alert">
              <span class="alert-icon">‚ö†Ô∏è</span>
              {{ saleErrorMessage() }}
            </div>
          }

          @if (saleSuccessMessage()) {
            <div class="alert success" role="status">
              <span class="alert-icon">‚úì</span>
              {{ saleSuccessMessage() }}
            </div>
          }

          <!-- D√©tails du produit trouv√© -->
          @if (foundProduct()) {
            <div class="product-details-card">
              <div class="product-details-header">
                <h4>üì¶ Produit trouv√©</h4>
              </div>
              <div class="product-details-body">
                <div class="detail-row">
                  <span class="detail-label">Nom:</span>
                  <span class="detail-value"><strong>{{ foundProduct()!.name }}</strong></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Code-barres:</span>
                  <span class="detail-value"><code>{{ foundProduct()!.barcode }}</code></span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Stock disponible:</span>
                  <span class="detail-value stock-available">
                    <span class="stock-badge">{{ foundProduct()!.stockQuantity }} unit√©s</span>
                  </span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Poids unitaire:</span>
                  <span class="detail-value">{{ foundProduct()!.unitWeight }} kg</span>
                </div>
                @if (foundProduct()!.description) {
                  <div class="detail-row full-width">
                    <span class="detail-label">Description:</span>
                    <span class="detail-value">{{ foundProduct()!.description }}</span>
                  </div>
                }
              </div>

              <!-- Formulaire de quantit√© -->
              <div class="quantity-section">
                <label class="form-field">
                  <span>Quantit√© √† vendre</span>
                  <input 
                    type="number" 
                    formControlName="quantity" 
                    min="1" 
                    [max]="foundProduct()!.stockQuantity"
                    placeholder="1"
                  />
                  @if (saleForm.controls.quantity.touched && saleForm.controls.quantity.invalid) {
                    <span class="error">La quantit√© doit √™tre au moins 1</span>
                  }
                </label>

                <button 
                  type="button" 
                  class="btn-process-sale" 
                  (click)="addToCart()"
                  [disabled]="saleForm.controls.quantity.invalid || saleForm.controls.quantity.value > foundProduct()!.stockQuantity"
                >
                  ‚ûï Ajouter au panier
                </button>
              </div>
            </div>
          }

          @if (cart().length > 0) {
            <div class="cart-section">
              <div class="cart-header">
                <h4>üõí Panier</h4>
                <span class="cart-total">{{ cartTotal() }} article(s)</span>
              </div>

              <div class="cart-items">
                @for (item of cart(); track item.product.id; let i = $index) {
                  <div class="cart-item">
                    <div class="cart-item-info">
                      <span class="cart-item-name">{{ item.product.name }}</span>
                      <span class="cart-item-barcode">{{ item.product.barcode }}</span>
                    </div>
                    <div class="cart-item-qty">
                      <input
                        type="number"
                        min="1"
                        [max]="item.product.stockQuantity"
                        [value]="item.quantity"
                        (change)="updateCartItemQuantity(i, $any($event.target).valueAsNumber)"
                      />
                      <button type="button" class="btn-remove" (click)="removeFromCart(i)">‚úï</button>
                    </div>
                  </div>
                }
              </div>

              <div class="cart-actions">
                <button
                  type="button"
                  class="btn-process-sale"
                  (click)="processSale()"
                  [disabled]="isProcessingSale()"
                >
                  @if (isProcessingSale()) {
                    <span class="spinner"></span>
                    Traitement en cours...
                  } @else {
                    üí∞ Valider la vente
                  }
                </button>
              </div>
            </div>
          }
        </form>
      </div>
    </section>
  </div>
}

<!-- Formulaire Modal √âtag√®re -->
@if (isShelfFormOpen()) {
  <div class="modal-backdrop" role="presentation" (click)="closeShelfForm()"></div>
  <div class="modal" role="dialog" aria-modal="true" [attr.aria-labelledby]="shelfFormMode() === 'add' ? 'add-shelf-title' : 'edit-shelf-title'">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <div>
          @if (shelfFormMode() === 'add') {
            <div class="form-header-icon">‚ûï</div>
            <h2 id="add-shelf-title">Ajouter une √©tag√®re</h2>
          } @else {
            <div class="form-header-icon">‚úé</div>
            <h2 id="edit-shelf-title">Modifier l'√©tag√®re</h2>
          }
        </div>
        <button class="icon-button" type="button" (click)="closeShelfForm()" aria-label="Fermer">
          ‚úï
        </button>
      </header>

      <form class="product-form" [formGroup]="shelfForm" (ngSubmit)="submitShelf()">
        <div class="form-grid">
          <label class="form-field full-width">
            <span>Nom de l'√©tag√®re *</span>
            <input type="text" formControlName="name" placeholder="Ex: √âtag√®re A1" />
            @if (shelfForm.controls.name.touched && shelfForm.controls.name.invalid) {
              <span class="error">Le nom est obligatoire.</span>
            }
          </label>

          <label class="form-field">
            <span>Poids maximum (kg) *</span>
            <input type="number" formControlName="maxWeight" min="0.1" step="0.1" placeholder="50" />
            @if (shelfForm.controls.maxWeight.touched && shelfForm.controls.maxWeight.invalid) {
              <span class="error">Le poids maximum doit √™tre sup√©rieur √† 0.</span>
            }
          </label>

          <label class="form-field">
            <span>Seuil minimum (kg) *</span>
            <input type="number" formControlName="minThreshold" min="0.1" step="0.1" placeholder="5" />
            @if (shelfForm.controls.minThreshold.touched && shelfForm.controls.minThreshold.invalid) {
              <span class="error">Le seuil minimum doit √™tre sup√©rieur √† 0.</span>
            }
          </label>
        </div>

        @if (errorMessage()) {
          <div class="alert error" role="alert">
            <span class="alert-icon">‚ö†Ô∏è</span>
            {{ errorMessage() }}
          </div>
        }
        @if (successMessage()) {
          <div class="alert success" role="status">
            <span class="alert-icon">‚úì</span>
            {{ successMessage() }}
          </div>
        }

        <div class="modal-actions">
          <button class="secondary" type="button" (click)="closeShelfForm()">Annuler</button>
          <button class="primary" type="submit" [disabled]="isSavingShelf()">
            @if (isSavingShelf()) {
              <span class="spinner"></span>
              Enregistrement...
            } @else {
              üíæ Enregistrer
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}


